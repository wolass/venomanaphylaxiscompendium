---
title: "Insect venom anaphylaxis: a case - control study of the European Anaphylaxis Registry"
author:
  - Wojciech Francuzik^1^
  - Sabine Dölle-Bierke^1^
  - Franziska Ruëff^2^ 
  - Claudia Pföhler^3^
  - Kathrin Scherer Hofmeier^4^
  - Margitta Worm^1^
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
    #bookdown::html_document2:
    bookdown::word_document2:
      fig_caption: yes
      reference_docx: "../templates/template.docx" # Insert path for the DOCX file
bibliography: references.bib
csl: "../templates/journal-of-archaeological-science.csl" # Insert path for the bib-style
---

^1^ Department of Dermatology, Venerology, and Allergology, Charité – Universitätsmedizin Berlin, corporate member of Freie Universität Berlin, Humboldt-Universität zu Berlin, and Berlin Institute of Health, Charitéplatz 1, 10117 Berlin,

^2^ Department of Dermatology and Allergology, Klinikum der Universität München, Germany 

^3^ Department of Dermatology, Saarland University Hospital, Homburg/Saar, Germany

^4^ Department of Dermatology, University Hospital Basel, Switzerland

**Corresponding author: **
  Prof. Dr. med. M. Worm margitta.worm@charite.de
Phone: +49 30 450 529 005;      Fax: +49 30 450 529 902

**Keywords:**
  anaphylaxis, adrenaline (epinephrine), beta-blockers, insect venom allergy, yellow-jacket

**Highlights:**
  These are the highlights. 
**Document statistics:**
  Word count, figures, tables, references


<!-- This is the format for text comments that will be ignored during renderings. Do not put R code in these comments because it will not be ignored. -->

```{r setup, echo = FALSE,warning=FALSE,include=F}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  echo = FALSE,
  comment = "#>",
  fig.path = "../figures/"
)

devtools::load_all('.',quiet = T) # Or use devtools::load_all('.', quiet = T) if your code is in script files, rather than as functions in the `/R` diretory
###### SETUP

```


# Abstract
Insect-venom elicited anaphylaxis is a common hypersensitivity reaction which may be life-threatening. Using the data from the European Anaphylaxis Registry (`r nrow(data)` cases in total) we identified insect-venom elicited anaphylaxis cases (n = `r {data$d_elicitor_gr5=="insects"} %>% sum()`) and analyzed these in comparison to anaphylaxis elicited by other elicitors (n = `r {data$d_elicitor_gr5!="insects"} %>% sum()`).

The data show that `r {{rdb$q_340_insects=="yellow jacket"} %>% sum(na.rm=T)/sum({!is.na(rdb$q_340_insects)})*100} %>% {round(.,1)}`% of all insect elicited cases were elicited by yellow jackets, followed by bees (`r {{rdb$q_340_insects=="bee"} %>% sum(na.rm=T)/sum({!is.na(rdb$q_340_insects)})*100} %>% {round(.,1)}`%). The insect venom elicited cases occurred mostly in outdoor places (`r rdb %>% filter(!is.na(q_340_insects)) %>% group_by(q_152_location) %>% summarize(n=n()) %>% {.[c(4),2] %>% sum()/(.[,2] %>% sum)*100} %>% round(1)`%) patients' homes (`r rdb %>% filter(!is.na(q_340_insects)) %>% group_by(q_152_location) %>% summarize(n=n()) %>% {.[c(8),2] %>% sum()/(.[,2] %>% sum)*100} %>% round(1)`%) or urban places (`r rdb %>% filter(!is.na(q_340_insects)) %>% group_by(q_152_location) %>% summarize(n=n()) %>% {.[c(5),2] %>% sum()/(.[,2] %>% sum)*100} %>% round(1)`%). 

Skin, gastrointestinal and respiratory symptoms occurred less frequently in insect elicited cases of anaphylaxis, whereas cardiologic symptoms (with hypotension, collapse, and loss of consciousness) were more frequent.  Intramuscular adrenaline (as a first-line therapy) was administered significantly less often in insect venom elicited cases (`r rdb %>% filter(!is.na(q_340_insects)) %>% group_by(d_522_adren_agg) %>% summarize(n=n()) %>% {.[2,2]/(.[1,2])*100} %>% round(1)`% vs `r rdb %>% filter(is.na(q_340_insects)) %>% group_by(d_522_adren_agg) %>% summarize(n=n()) %>% {.[2,2]/(.[1,2])*100} %>% round(1)`, p < 0.0001). The mortality rate in insect anaphylaxis was comparable to other cases (0.295%, p = 0.174).

Patients who experienced insect-venom anaphylaxis were older (p < 0.0001), more often had concomitant mastocytosis (p < 0.0001) and cardiologic conditions (p < 0.0001) and females more often had concomitant thyroid diseases and less often suffered from a food allergy or atopic dermatitis. 

Symptoms of insect venom anaphylaxis are distinctively different from other reactions, indicating that the therapy of insect elicited cases of anaphylaxis should be considered separately. Indeed we observed different therapeutic patterns in insect elicited cases of anaphylaxis (more antihistaminics but fewer corticosteroids, bronchodilators, and surprisingly - adrenaline). This indicates that the management of insect-venom induced anaphylaxis may be improved and is especially required in patients with concomitant cardiologic conditions and these with hyperreactive mast cells. 



# Introduction

# Methods

The European Anaphylaxis Registry [@Grabenhenrich2016] database from March 2019 was searched for anaphylaxis cases elicited by insect's venom. The flowchart in figure \@ref(fig:flowchart) represents the detailed case-selection process. 

The final database consisted of `r countries %>% summarise(sum(n))` cases of insect elicited anaphylaxis from `r countries %>% summarize(length(n))` countries. Severe reactions were identified based on the definition by NIAID/FAAN [@Sampson2006] or as Ring and Messmer Scale - grades III and IV) and presented with significant hypoxia, hypotension, confusion, collapse and loss of consciousness, or incontinence. 
We compared the frequency of various elicitors, symptoms, and factors known to increase the risk of severe anaphylaxis [@Worm2018] in both groups. We evaluated symptoms, management and risk factors of insect elicited cases in comparison to other known triggers of anaphylaxis.

We observed a significant difference in the clinical features of insect anaphylaxis in children and adults. The younger population significantly less often had concomitant conditions (i.e. DM, HT, malignant diseases and mastocytosis), and more often presented with atopic dermatitis, rhinitis, and asthma. Therefore, we decided to adjust the analysis for age and sex to reduce the comparison bias. When comparing the management of both types of anaphylaxis we also matched the control group according to severity.  

<!-- ## Data handling and statisitcs -->
The statistical analysis was performed in the R Statistical Package [@R]. A simple comparison of categorical variables was performed using either Chi^2^ test or Fisher's exact test (where the number of observation in a bin was less than 10), continuous variables were analyzed using Mann-Whitney U test. We defined statistical significance as α = 0.05. Data along with the analysis script can be accessed online at https://github.com/wolass/venomanaphylaxiscompendium.

# Results

## Temporal distribution of anaphylaxis cases by elicitor.

Insect venom elicited anaphylaxis in contrast to other elicitors showed a significant seasonal fluctuation and was frequently reported from May till October. Their proportion of IVA to anaphylaxis cases elicited by other triggers during the summer seasons reached 60% and was as under 1% of cases during winter. Nevertheless, `r rare_spring_autumn$n %>% sum` cases of IVA (bee in spring; yellow jacket in autumn) anaphylaxis were also reported in March, April and November. Yellow-jacket was the most prominent IVA-causing insect followed by bees. The IVA-causing insects differed in European countries with hornets being more prominent in the south of Europe. IVA was more frequent in adults and seniors when compared to children and young adults. (Fig \@ref(fig:insectstime)B). 

When we looked at the density plot of cases according to age - we saw a bimodal distribution forming two subset of patients with a cutoff age of 22 (Fig \@ref(fig:flow)B.

## Symptoms

IVA showed a specific symptom pattern. Patients, who underwent IVA, more often experienced cardiologic symptoms (dizziness, reduced alertness, unconsciousness) than in other elicitors of anaphylaxis and less often showed gastrointestinal symptoms (Fig \@ref(fig:figsymptoms)A). The difference in severe hypotension frequency was especially prominent in the younger group under 22 (Fig. S\@ref(fig:hypotensionkids)). 

The pattern of organ involvement showed similarities in gastrologic, skin and respiratory symptoms, and did not differ in the proportion of elevated baseline serum tryptase (> 8 ng/ml). Although, less concomittant atopic diseases were seen in patients undergoing IVA (Fig \@ref(fig:figsymptoms)B).

Severe reactions were more prevalent in older patients in comparison to patients under 22, and in IVA cases vs other elicitors (Fig. \@ref(fig:sev)D). There were no differences in severity of reactions elicited by yellow-jackets and insect species. 

## Repeated reactions

```{r repreactvars}
treact <- table(rdb$grouping,rdb$q_160_ever_react)[,1:2] %>% prop.table(1)*100
p <- table(rdb$grouping,rdb$q_160_ever_react)[,1:2] %>% summary() %>% {.$p.value}
```

In general `r treact[1,2] %>% round(1)`% of patients with insect allergy had experienced anaphylaxis in the past. If the reaction was elicited by other elcitors previous reactions were more frequently seen (`r treact[2,2]%>% round(1)`%, `r p %>% pval()`).  We observed `r sum(repeated_reaction_in_Reg)` patients with two documented reactions in our registry. Out of these `r sum(greater_same[,2])` (`r (sum(greater_same[,2])/sum(repeated_reaction_in_Reg)*100)%>% round(1)`%) had Insect elicited anaphylaxis and in `r greater_same[1,2]` (`r greater_same[1,2]/sum(greater_same[,2])*100`%) the following reaction was more severe than before. In `r greater_same[3,2]` (`r (greater_same[3,2]/sum(greater_same[,2])*100) %>% round(1)`%) cases the reaction was graded exactly as before.


## Co-factors

The factor most prominently associated with an increased risk of severe anaphylaxis was mastocytosis, and there were no differences in elicitor groups (Fig. \@ref(fig:figcofactors)). Mastocytosis was increasing the risk of cardiac arrest in patients undergoing IVA significantly more than in patients undergoing anaphylaxis due to other triggers (Fig. S\@ref(fig:cardiacmasto)). 

Concomitant cardiovascular diseases were associated with higher risk of severe anaphylaxis when elicited by insects. They played insignificant role when anaphylaxis was triggered by other elicitors (Fig. \@ref(fig:figcofactors)). 

Risk of severe anaphylaxis in patients concomitantly using ACE-I (as well as beta-blockes) could not be independently measured due to coexsisting cardiovascular pathologies. ACE-I use was however more often associated with cardiac arrests in both IVA and anaphylaxis by other triggers (Fig. \@ref(fig:figcofactors)C). Whereas beta-blockers use was associated with higher severity of anaphylaxis and with cardiovascular symptoms (cardiac arrest, chest pain). Suprisingly, arrhythmia was more frequently reported in patients undergoing IVA with concomitant beta-blockers (Fig. \@ref(fig:figcofactors)D). 

Baseline serum tryptase correlated with the severity of reactions in the Ring and Messmer scale and was more prominently increasing risk of severe anaphylaxis in IVA patients than in other cases (Fig. \@ref(fig:figcofactors)B).
Cases with cardiac arrest were associated with increased tryptase over 8 ng/ml and this proportion was higher in IVA when compared to other elicitors. Loss of consciousness was also associated with increased tryptase levels but only in patients with IVA (Fig. \@ref(fig:figcofactors)C). Based on the severity and symptom profile, we decided to use a tryptase cut off value of 8 ng/ml (Fig. S\@ref(fig:tryp2)) rather than the currently used 11.5 ng/ml.

We compared the Hymenoptera species responsible for triggering IVA according to the severity of the reaction. Patients matched according to sex and age had similar reactions to bees and yellow-jackets when severity of a reaction was considered. 
<!-- This data, however, is not comparable to the refractory anaphylaxis cases as refractory anaphylaxis seems to be a distinct phenotype.  -->

```{r physactivivty}
ttexercise2 <- age_sex_matched %>% 
  filter(!is.na(grouping),
         q_4211_exercise != "unknown") %>% 
  group_by(grouping,q_4211_exercise,d_severity_rmr) %>% 
  summarize(n = n()) %>% 
  filter(grouping == "insects") %>% 
  spread(key = q_4211_exercise, value = n) %>% 
  {chisq.test(.[,3:4])$p.value} %>% pval
  # ggbarplot(x = "q_4211_exercise",
  #           y = "n",
  #           facet.by = "grouping",
  #           fill = "d_severity_rmr",
  #           position = position_fill())

ttexercise1 <- age_sex_matched %>% 
  filter(!is.na(grouping),
         q_4211_exercise != "unknown") %>% 
  group_by(grouping,q_4211_exercise) %>% 
  summarize(n = n()) %>% 
  spread(key = q_4211_exercise,value = n) %>% 
  {.[,2:3]} %>% chisq.test() %>% {.$p.value} %>% pval()



```

Physical exercise in the fresh air (e.g. jogging in the park) predisposed to anaphylaxis due to insect stings (`r ttexercise1`).
But even though the physical exercise was more often associated with IVA than other triggers of anaphylaxis - it was not predictive of the severity of a reaction in these patients, as there were no differences in relation to concomitant exercise (`r ttexercise2`).

## Management

```{r}
ttadren1 <- ANAscore_matched %>% 
  group_by(d_522_adren_agg,grouping) %>% 
  summarize(n = n()) %>% 
  spread(key = grouping, value = n) %>% 
  {chisq.test(.[,2:3])$p.value} %>% 
  pval()
```

Patients who underwent IVA significantly less often received adrenaline treatment than in other anaphylaxis cases (26.9% vs 34.6%, `r test_adrenuse1$p.value %>% pval()`). After adjusting both groups for similar age, sex and severity distribution - the difference in adrenaline use was still significant irrespective of the administration route (`r ttadren1`, Fig \@ref(fig:adrenalineuse)). 
<!-- Antihistaminic drugs, on the other hand, were given more often in cases of IVA when compared to non-IVA. -->
IVA was most often treated with corticosteroids and antihistamines (significantly more frequently than in other anaphylaxis cases). On the other hand adrenaline, beta-2 mimetics and oxygen were given more often in non-IVA. 

We discovered clusters of associated symptoms and therapy modes in IVA patients (association measured useing phi). Cardiologic symptoms (cardiac arrest, hypotension, loss of consciousness) and urticaria, were treated more similarly than  respiratory or gastroenteral symptoms (Fig. \@ref(fig:adrenalineuse)C). Therapy of these symptoms consisted of adrenaline autoinjector (AAI), i.v. adrenaline in multiple doses, 100% oxygen inhalation, an initial dose of antihistamines, and inhaled β-2 agonists. 
Corticosteroids, i.v. volume replacement and i.v. β-2 agonists formed another therapy mode. 

The most differences in the therapy of IVA vs. other forms of anaphylaxis was observed in the frequency of inhaled beta2-agonists and antihistamines (probably because these are not available for the IVA patients, but atopic patients use them regularly) (Fig. \@ref(fig:adrenalineuse)B).




<!-- ### Mastocytosis -->

<!-- ### Older Age -->

<!-- ### ACE - I -->

<!-- ### previous reactions (severe) -->

<!-- ### Male sex -->

<!-- ### Beta blockers and CARDIOSELECTIVE BLOCKERS -->

<!-- ### Evaluate the pediatric population separately -->

<!-- ### Number of SAR during VIT compare to other hypos -->
<!-- #### Compare bee sit to wasp sit for AEs -->
<!-- #### correlate the tryptase value with SIT types and severity -->


# Discussion

Cardiologic symptoms and hypotensive collapse might be associated with venom anaphylaxis due to the vaso-vagal reflex. As seen in patients undergoing blood sampling needles (and probably also insect stings) may elicit a hypotensive response due to extreme emotional distress with bradycardia, limiting the blood flow to the brain and causing syncope. This mechanism may contribute to the ongoing histamine-induced vasodilatation and may worsen the symptoms of an allergic reaction.



# Conclusion

# Acknowledgements

<!-- The following line inserts a page break when the output is MS Word. For page breaks in PDF, use \newpage on its own line.  -->
##### 

# References 
<!-- The following line ensures the references appear here for the MS Word or HTML output files, rather than right at the end of the document (this will not work for PDF files):  -->
<div id="refs"></div>

##### 

# Figures




```{r flow,fig.width=6,fig.height=6, fig.cap=" A) Flow-diagram illustrating the rationale for including registry cases in the final analysis. B,C,D: Age, sex, and severity distribution was matched in cases in both groups to allow for comparable results between IVA and non-IVA cases. Two age-subsets of patients could be recognized based on the density plot of age (B)."}
ggarrange(ggplot()+
            background_image(png::readPNG("../figures/flow.png")),
          lower_panel,
          ncol = 1,
          nrow = 2,
          heights = c(1,0.4),
          labels = c("A","")
)
```

##### 

```{r insectstime, fig.cap="A: Proportion of anaphylaxis cases elicited by specific insects according to the month in which the reaction occurred. Less frequent insect species were grouped together as 'other'. B: The density distribution of IVA cases to cases elicited by other triggers considering the patient's age. C: Geographical differences in the most common elicitors of IVA. Countries which reported less than 10 IVA cases were not illustrated in this figure.", fig.height=4, fig.width = 7}
fig_basic
```


##### 

```{r figsymptoms, fig.cap="Symptoms of insect venom anaphylaxis (IVA) compared to other elicitors. A: Proportional presentation of specific reaction symptoms. B: High-level overview of involved organ systems and selected cofactors in form of a radar plot.", fig.width=8.5, fig.height = 3.2}
fig_symptoms
```

##### 

```{r figcofactors, fig.cap="Cofactors of insect venom anaphylaxis. A: Odds ratios of eliciting severe anaphylaxis. B: Proportion of cases elicited by insects or other elicitors (upper panels) according to tryptase levels and cardiologic symptoms. ", fig.width = 5.6, fig.height = 10}
cof_fig
```


##### 

```{r adrenalineuse, fig.cap = "Therapy in patients with IVA compared to oter elicitors, cases matched according to sex, age and severity of a reaction. A: Proportional use of therapy measures in both anaphylaxis groups.  B: Heatmap visualizing the associacion of symptoms and corresponding treatment -  presented as a scaled correlation coefficient (phi).", fig.height=10, fig.width = 7}

ggpubr::ggarrange(
    plotManagement,
    
  #lower_panel,
  matrix_venom$p+
    labs (x = "", y = "")+
    geom_segment(aes(x = c(8.5),
                     xend = c(8.5), 
                     y = c(0.5),
                     yend = c(39.5)),color = "red")+
    geom_segment(aes(x = c(0.5),
                     xend = c(20.5), 
                     y = c(28.5),
                     yend = c(28.5)), color = "red" )+
    geom_segment(aes(x = c(0.5),
                     xend = c(20.5), 
                     y = c(34.5),
                     yend = c(34.5)), color = "red", linetype = 2  ),
  nrow = 2,
  heights = c(1.5,3),
  labels = c("","C")
)

# ggarrange(matrix_venom$py+
#             theme(plot.margin=unit(c(0.1,9.8,0,9.5),"lines")),
#           ggarrange(matrix_venom$p,
#                     matrix_venom$px+
#                       theme(plot.margin=unit(c(1,0,8,0),"lines")),
#                     widths = c(1,0.2)),
#           ncol = 1,
#           nrow = 2,
#           heights = c(0.2,1)
# )

```




# Supplementary Figures

```{r treatmentmatrixother}
#matrix_other
```

```{r crammersv}
tests_matched %>%
    mutate(organ = factor(ifelse(grepl(variableName,pattern = "111"),"skin",
                          ifelse(grepl(variableName,pattern = "112"),"gastro",
                                 ifelse(grepl(variableName,pattern = "113"),"respiratory",
                                        ifelse(grepl(variableName,pattern = "114"),"cardio",NA)))),
                          levels = c("respiratory","cardio","gastro","skin"))
           ) %>%
    filter(!is.na(Cramer),
           section == "symptoms",
           Cramer > 0.11,
           !(variableName %in% c("q_114","q_143_fatal_adre_v5", "q_112_abdominal_pain")))%>%
    mutate(variableName = car::recode(variableName,
                                      "'q_112_nausea' = 'nausea';
                                      'q_114_loss_of_consciousness' = 'unconsciousness';
                                      'q_113_throat_tightness_v5' = 'throat tightness';
                                      'q_114_reductions_of_alertness' = 'reduced allertness';
                                      'q_112_incontinence' = 'incontinence';
                                      'q_112_abdominal_pain' = 'abdominal pain';
                                      'q_112_diarrhoea' = 'diarrhoea';
                                      'q_113_wheezing_expiratory_distress_v5' = 'expiratory distress';
                                      'q_113_rhinitis_v5' = 'rhinitis';
                                      'q_114_dizziness' = 'dizziness';
                                      'q_114_hypotension_collapse_v5' = 'hypotension';
                                      'q_111' = 'any skin symptoms'"
    )) %>% #{.[,1]}
    ggdotchart(x = "variableName",
               y = "Cramer",
               color = "organ",
               palette = "lancet",
               sorting = "descending",
               add = "segments",
               add.params = list(color = "organ"),
               rotate = T,
               #group = "organ",
               dot.size = 5,
               size = 2,
               #label = "Cramer"
               ggtheme = theme_pubr())+
    labs(x = "",y = "Cramer's V",color = "")+
    theme(legend.justification = c(-3,0))

```

```{r sev, fig.cap="Severity of anaphylaxis in subgroups. Severity of patients with IVA in two age groups (left), according to elicitor type (center) and according to the responsible insect species (right)"}
severity_joined_brown %>%
    ggbarplot(x = "grouping",
              y = "n",
              fill = "d_severity_rm",
              position = position_fill(reverse = F),
              color = "d_severity_rm",
              palette = c("#848484","#1f1f1f"))+
    facet_grid(.~subset,scale = "free_x",space = "free_x")+
    labs(fill = "Severity")+
    theme(axis.title.x =  element_blank(),
          axis.text.x = element_text(angle=20,hjust = 1),
          legend.position = "right"
    )+
    #annotate("text",x = 1.5, y = 0.5, label = c("*"),
     #        size =12)+
    guides(color = F)
```


```{r hypotensionkids, fig.cap="Hypotension in IVA of kids"}
hypotensionPlot
```

```{r}
ggarrange(dt,
          dt3 %>%
ggbarplot(x = "q_610_sit_prior_v5",
          y = "n",
          fill = "severity_brown",
          position = position_fill())+
  labs(fill="FAAN"))
```

```{r cofactorscomparison}
#testInsectsbinomialTab$cofactors[,-7] %>% knitr::kable()

testInsectsbinomialTab$cofactors[,-7] %>%
  tidyr::gather(value ="Proportion",
         key="Group",
         4:5) %>% 
  ggplot(aes(reorder(variableName,-Proportion),Proportion,fill=Group))+
  geom_bar(stat="identity",position="dodge")+
  theme(axis.text.x=element_text(angle=90))
```

```{r severityinsectspecies}
yj_bee %>%
  ggbarplot(x = "grouping",
            y = "n",
            fill = "d_severity_rm",
            position = position_fill())

```

```{r acei, fig.cap="Ace inhibitors and cardiologic symptoms"}

ggarrange(
  plot_ace_cardiacs,
ggarrange(rdb %>% 
  filter(d_elicitor_gr5=="insects") %>% 
ggplot(aes(q_423_ace,q_116_VAS_v7))+
  geom_boxplot(),
rdb %>% 
  filter(d_elicitor_gr5=="insects") %>% 
ggplot(aes(q_423_ace,ANAscore))+
  geom_boxplot()
),
nrow = 2,
ncol = 1
)

```

```{r betas, fig.cap = "Beta blockers and cardiologic symptoms"}
rdb_temp <- rdb
rdb_temp$q_423_beta <- yesonly(rdb_temp$q_423_beta)

wilcox.test(q_116_VAS_v7~q_423_beta,data = rdb_temp)
rdb_temp %>% 
  filter(d_elicitor_gr5=="insects") %>% 
ggplot(aes(q_423_beta,q_116_VAS_v7))+
  geom_violin()

rdb_temp %>% 
  filter(d_elicitor_gr5=="insects") %>% 
group_by(q_423_beta) %>% 
  summarise(medianVAS=median(q_116_VAS_v7,na.rm=T),
            IQRVAS = IQR(q_116_VAS_v7,na.rm=T))


wilcox.test(ANAscore~q_423_beta,data = rdb_temp %>% 
  filter(d_elicitor_gr5=="insects") 
)

rdb_temp %>% 
  filter(d_elicitor_gr5=="insects") %>% 
ggplot(aes(q_423_beta,ANAscore))+
  geom_violin()
rdb_temp %>% 
  filter(d_elicitor_gr5=="insects") %>% 
 group_by(q_423_beta) %>% 
  summarise(medianANAscore=median(ANAscore,na.rm=T),
            IQRANAscore = IQR(ANAscore,na.rm=T))


ggarrange(
  plot_beta_cardiacs,
  ggarrange(
    rdb_temp %>% 
  filter(d_elicitor_gr5=="insects") %>% 
ggplot(aes(q_423_beta,q_116_VAS_v7))+
  geom_boxplot(),
rdb_temp %>% 
  filter(d_elicitor_gr5=="insects") %>% 
ggplot(aes(q_423_beta,ANAscore))+
  geom_boxplot()
  ),
nrow =2,
ncol = 1
)

```

```{r cardiacmasto, fig.cap = "MAsotcytosis and cardiologic symptoms" }
cardiac_masto_plots[[6]]+
              labs(x = "cardiac arrest")
```

```{r tryp, fig.cap="Severity of anaphylaxis is influenced by baseline serum tryptase levels with the cut off of 8 ng/ml in IVA (top row) vs other anaphylaxis cases",fig.width = 7}
ggarrange(
rdb %>% 
  filter(d_elicitor_gr5=="insects") %>% 
  mutate(typ_cat=ifelse(q_212_tryptase_value_v5<8,
                  "low",
                  "high")) %>% 
  filter(!is.na(typ_cat)) %>% 
  ggplot(aes(typ_cat,q_116_VAS_v7))+
  geom_boxplot(),
rdb %>% 
  filter(d_elicitor_gr5=="insects") %>% 
  mutate(typ_cat=ifelse(q_212_tryptase_value_v5<8,
                  "low",
                  "high")) %>% 
  filter(!is.na(typ_cat)) %>% 
  ggplot(aes(typ_cat,ANAscore))+
  geom_boxplot(),
rdb %>% 
  filter(d_elicitor_gr5=="insects",
         !is.na(d_severity_rm)) %>% 
  mutate(typ_cat=ifelse(q_212_tryptase_value_v5<8,
                  "low",
                  "high"),
         d_severity_rm = factor(d_severity_rm)) %>% 
  group_by(d_severity_rm,typ_cat) %>% 
  filter(!is.na(typ_cat)) %>% 
    summarize(n = n()) %>% 
  ggplot(aes(typ_cat,n,fill=d_severity_rm))+
  geom_bar(stat="identity",position= "fill"),
rdb %>%
  filter(d_elicitor_gr5!="insects") %>%
  mutate(typ_cat=ifelse(q_212_tryptase_value_v5<8,
                  "low",
                  "high")) %>%
  filter(!is.na(typ_cat)) %>%
  ggplot(aes(typ_cat,q_116_VAS_v7))+
  geom_boxplot(),
rdb %>%
  filter(d_elicitor_gr5!="insects") %>%
  mutate(typ_cat=ifelse(q_212_tryptase_value_v5<8,
                  "low",
                  "high")) %>%
  filter(!is.na(typ_cat)) %>%
  ggplot(aes(typ_cat,ANAscore))+
  geom_boxplot(),
rdb %>%
  filter(d_elicitor_gr5!="insects",
         !is.na(d_severity_rm)) %>%
  mutate(typ_cat=ifelse(q_212_tryptase_value_v5<8,
                  "low",
                  "high"),
         d_severity_rm = factor(d_severity_rm)) %>%
  group_by(d_severity_rm,typ_cat) %>%
  filter(!is.na(typ_cat)) %>%
    summarize(n = n()) %>%
  ggplot(aes(typ_cat,n,fill=d_severity_rm))+
  geom_bar(stat="identity",position= "fill"),
ncol =3 , nrow = 2,
widths = c(1,1.1,2))

```


```{r yjbee, fig.height=8, fig.width = 7, fig.cap="Models of severity and the influence of jellow jacket vs bees"}
require(broom)

ana_outcome_matched <- function(data = data4,
         outcome = "d_severity_rmr",
         matching_var = "q_340_insects",
         confounders_cat = c("b_sex", "cc_cardio"),
         confounders_int = c("d_age"),
         selected_predictors = c(1:4)
         ){
  possible_outcomes <- c("d_severity_rm",
                         "d_severity_rmr",
                         "severity_brown",
                         "q_116_VAS_v7",
                         "ANAscore")
  predictors <- c(matching_var, confounders_cat,confounders_int)
  df <- data %>% # first get the data frame
   filter(!!as.name(matching_var) %in% c("yellow jacket", "bee")) %>% 
   select(!!!matching_var,
          !!!outcome,
          !!!confounders_cat,
          !!!confounders_int
          ) %>%
          {.[complete.cases(.),]}
  ### we need to match the cases now to the first level of theoutcome variable
  ref_level <- levels(df[,matching_var] %>% droplevels())
  matched <- df %>% 
    mutate(match = ifelse(!!as.name(matching_var)==ref_level[1],T,F),
           out=ifelse(!!as.name(outcome)=="severe",1,0)) %>% 
    matchit(formula = as.formula(
      paste("match ~ ",paste0(confounders_cat),"+", paste0(confounders_int,collapse = " + ")))) %>% 
    match.data() 
  ## IFELSE
  if(outcome %in% possible_outcomes[c(2,3)]){
    plot <- matched %>% 
      ggplot(aes(!!as.name(matching_var),
               fill = !!as.name(outcome)))+
      geom_bar()+
      facet_grid(reformulate(confounders_cat[1],confounders_cat[2]))
  
    fit <- glm(as.formula(paste0(
      "out ~ ",paste0(predictors[selected_predictors], collapse = " + ")
    )),data= matched,family= "binomial")
  } else if (outcome %in% possible_outcomes[c(1,4,5)]){
     plot <- matched %>% 
      ggplot(aes(!!as.name(matching_var),
               y = !!as.name(outcome)))+
      geom_boxplot()+
      facet_grid(reformulate(confounders_cat[1],confounders_cat[2]))
  
    fit <- glm(as.formula(paste0(
      outcome, " ~ ", paste0(predictors[selected_predictors], collapse = " + "))),
             data = matched)
  }
  
  return(list(mtched_df = matched,
              ref_level = ref_level,
              fit = fit,
              plot = plot)) 
}

possible_outcomes <- c("d_severity_rm",
                         "d_severity_rmr",
                         "severity_brown",
                         "q_116_VAS_v7",
                         "ANAscore")

output_severity <- lapply(possible_outcomes,
                         function(x){
                         ana_outcome_matched(data = data4,
                            outcome = x,
                            matching_var = "q_340_insects",
                            confounders_cat = c("b_sex", "cc_cardio"),
                            confounders_int = c("d_age"),
                            selected_predictors = c(1:4))
                           }
)


do_cof_tab <- function(x){
  output_severity[[x]]$fit %>% summary() %>% {.$coefficients}%>% tidy() %>% as.matrix()
}
require(broom)
temp <- lapply(1:5,do_cof_tab) %>% do.call(what = rbind) %>%
                          as_tibble() %>%
  {mutate(.,
         Estimate = as.numeric(Estimate),
         Pr...t.. = as.numeric(Pr...t..)
  )} %>%
          {cbind(.,outcome = lapply(possible_outcomes,
                          rep,
                          nrow(.)/5) %>% unlist)
          } %>% 
           filter(.rownames!="(Intercept)")
gridExtra::grid.arrange(output_severity[[2]]$plot,
                        output_severity[[3]]$plot,
                        output_severity[[1]]$plot,
                        output_severity[[4]]$plot,
                        output_severity[[5]]$plot,
                        temp %>% 
  ggplot(aes(.rownames,Pr...t.., color=outcome))+
  geom_segment(x=0.5,xend=4.5,y=log10(0.05),yend=log10(0.05))+
  scale_y_log10()+
  geom_jitter()+
  theme(axis.text.x = element_text(angle=40, hjust=1))+
    annotate("text",x=4,y = c(log10(c(0.0001,0.00001,.000001,.0000001,.00000001))),
             label = c(1776,1780,1206,234,1780))
  )#+
  #geom_line(aes(group=outcome))
```

```{r modelfitness, fig.cap="Comparison of modelling to different severity scales."}

ggplot(temp,aes(.rownames,Pr...t.., color=outcome))+
  geom_segment(x=0.5,xend=4.5,y=log10(0.05),yend=log10(0.05))+
  scale_y_log10()+
  geom_jitter(width = 0.2)+
  theme(axis.text.x = element_text(angle=40, hjust=1))+
    annotate("text",x=4,y = c(0.0001,0.00001,.000001,.0000001,.00000001)*10,
             label = c("n=1776","n=1780","n=1206","n=234","n=1780"),size = 3)+
  labs(x = "",y="p value")
```

```{r tryp2,fig.height=8, fig.width = 7, fig.cap = "tryptase cut off value plot"}
output_severity <- lapply(possible_outcomes,
                         function(x){
                         ana_outcome_matched(data = data4,
                            outcome = x,
                            matching_var = "q_340_insects",
                            confounders_cat = c("tryp_cat", "cc_cardio"),
                            confounders_int = c("d_age"),
                            selected_predictors = c(1,2,4))
                           }
)


do_cof_tab <- function(x){
  output_severity[[x]]$fit %>% summary() %>% {.$coefficients}%>% tidy() %>% as.matrix()
}

temp <- lapply(1:5,do_cof_tab) %>% do.call(what = rbind) %>%
                          as_tibble() %>%
  {mutate(.,
         Estimate = as.numeric(Estimate),
         Pr...t.. = as.numeric(Pr...t..)
  )} %>%
          {cbind(.,outcome = lapply(possible_outcomes,
                          rep,
                          nrow(.)/5) %>% unlist)
          } %>% 
           filter(.rownames!="(Intercept)")
gridExtra::grid.arrange(output_severity[[2]]$plot,
                        output_severity[[3]]$plot,
                        output_severity[[1]]$plot,
                        output_severity[[4]]$plot,
                        output_severity[[5]]$plot,
                        temp %>% 
  ggplot(aes(.rownames,Pr...t.., color=outcome))+
  geom_segment(x=0.5,xend=4.5,y=log10(0.05),yend=log10(0.05))+
  scale_y_log10()+
  geom_jitter()+
  theme(axis.text.x = element_text(angle=40, hjust=1))
  )
```

```{r rfplot}
rf_ggplot_treatment
```

